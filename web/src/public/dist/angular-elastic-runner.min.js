!function(){"use strict";angular.module("app").factory("elasticCluster",["$location","$state","esFactory",function(e,r,t){var a=e.$$host+":9200",u=t({host:a});return{esClient:u}}])}(),function(){"use strict";function e(e,r,t,a){function u(e,r,a){var u={index:e,type:r,body:a},n={newDoc:u},o={params:n},s=t.get("/createdoc",o);return s}function n(e,r,a){var u={index:e,type:r,id:a},n={delDoc:u},o={params:n},s=t.get("/deletedoc",o);return s}return{createDoc:u,deleteDoc:n}}angular.module("app").factory("esModifySvc",["$location","$state","$http","elasticCluster",e])}(),function(){"use strict";function e(e,r,t){var a=function(e){var r={query:{filtered:{query:{match_all:{}},filter:e}}};return r};return{buildFilteredQueryFromFilter:a}}angular.module("app").factory("queryDslSvc",["$location","$state","elasticCluster",e])}(),function(){"use strict";function e(e,r,t,a){function u(e,r,a){var u={index:e,type:r,body:{query:{match:{_all:a}}}},n={searchQuery:u},o={params:n},s=t.get("/searchdoc_source",o);return s}function n(e,r){var a={index:e,type:r,body:{query:{match_all:{}},sort:{_id:"desc"}}},u={searchQuery:a},n={params:u},o=t.get("/searchdoc",n);return o}function o(e,r,a){var u={index:e,type:r,body:a},n={searchQuery:u},o={params:n},s=t.get("/searchdoc_source",o);return s}function s(e,r,a){var u={index:e,type:r,body:{aggs:{max_id:{max:{field:a}}},size:0}},n={searchQuery:u},o={params:n},s=t.get("/searchdoc",o);return s}function c(e,r,a,u){var n={index:e,type:r,body:{query:{term:{}}}};n.body.query.term[a]=u;var o={searchQuery:n},s={params:o},c=t.get("/searchdoc",s);return c}return{queryMatchAllTerms:u,queryMatchAllDesc:n,anyQuery:o,fieldMaxValue:s,termQueryByKV:c}}angular.module("app").factory("esSearchSvc",["$location","$state","$http","elasticCluster",e])}(),function(){"use strict";function e(e,r,t,a,u,n){var o=this;o.isWrapperToggled=!0,o.elasticBuilderData={},o.elasticBuilderData.fields={ingredients:{type:"term"},description:{type:"term"},name:{type:"term"},recipeYield:{type:"term"},datePublished:{type:"date"},source:{type:"multi",choices:["bbcfood","aspicyperspective","bonappetit","chow","101cookbooks","delishhh","naturallyella","thevintagemixer","thepioneerwoman"]}};var s=[{and:[{and:[{terms:{source:["bonappetit","bbcfood"]}},{range:{datePublished:{lte:"2013-02-01",format:"yyyy-MM-dd"}}}]},{term:{name:"chickpea"}}]}];0===u.data.hits.hits.length?o.elasticBuilderData.query=s:o.elasticBuilderData.query=u.data.hits.hits[0]._source.queryObject.queryFilter,o.elasticBuilderData.needsUpdate=!0;var c=function(e){var r=JSON.stringify(e,null,2);return r};o.showFilteredQuery=function(){o.filteredQuery=n.buildFilteredQueryFromFilter(o.elasticBuilderData.query),o.esQueryStringified=c(o.filteredQuery)};var i=function(r){t.anyQuery("openrecipes","recipe",r).then(function(r){var t=[];t=r.data,o.resultsArr=t,e.go("querybuilder.run-query")}).catch(function(r){o.errorMessage="querybuilder.run-failed",e.go("querybuilder.run-failed")})};o.runFilteredQuery=function(){i(n.buildFilteredQueryFromFilter(o.elasticBuilderData.query))};var l=function(e){return t.fieldMaxValue("openrecipes","query",e)};o.saveQuery=function(){l("queryObject.queryId").then(function(e){var r=e.data.aggregations.max_id.value+1,t={queryObject:{queryId:r,query:o.filteredQuery,queryFilter:o.elasticBuilderData.query,label:o.queryLabel}};a.createDoc("openrecipes","query",c(t)).then(function(e){console.log("Query saved succcessfully to ES!")}).catch(function(e){console.log("Failed to save query to ES!"),o.errorMessage=e.message,console.trace(e.message)})}).catch(function(e){console.log("Failed to retrieve max queryObject.id from ES !"),console.trace(e.message)})},o.isQLToggled=!1}angular.module("app").controller("queryBuilderCtrl",["$state","$stateParams","esSearchSvc","esModifySvc","builderQuery","queryDslSvc",e])}(),function(){"use strict";function e(e,r,t,a){var u=this;u.queryTerm="",u.recipes=[];var n=function(){var t=r.$parent.vm.queryTerm;a.queryMatchAllTerms("openrecipes","recipe",t).then(function(r){r.data[0].length>0&&(u.recipes=r.data,e.go("search.succeeded"))}).catch(function(r,t,a,u){e.go("search.failed")})};r.$on("PleaseQueryES",function(){n()})}angular.module("app").controller("esSearchCtrl",["$state","$scope","$http","esSearchSvc",e])}(),function(){"use strict";function e(e){function r(e,r,t,a,u){console.log("state change start",e,"toState:",r,"toParams:",t,"fromState:",a,"fromParams:",u)}function t(e,r,t,a,u){console.log("state change success",e,"toState:",r,"toParams:",t,"fromState:",a,"fromParams:",u)}function a(e,r,t,a,u,n){console.log("state change error",e,r,t,a,u,n)}function u(e,r,t,a){console.log("state not found",e,r,t,a)}e.$on("$stateChangeStart",r),e.$on("$stateChangeSuccess",t),e.$on("$stateChangeError",a),e.$on("$stateNotFound",u);var n={};return n}angular.module("app").factory("stateWatcherService",e),e.$inject=["$rootScope"]}(),function(){"use strict";function e(e,r,t,a,u,n,o){var s=this,c=[],i=function(){c.length=0;for(var e=o.data.hits.hits,r=0;r<e.length;r++)c.push(e[r]);return c};r.vmShared=r.vmShared||{resultQueries:i()},s.isQueryDisplayed=!0,s.showQuery=function(){e.go("listqueries.show-query")},s.queryResultsArr=[],s.runQuery=function(r){u.anyQuery("openrecipes","recipe",r.query).then(function(t){var a=[];a=t.data;var u={answerSet:a,queryLabel:r.label},n=s.queryResultsArr.map(function(e){return e.queryLabel}).indexOf(u.queryLabel);n===-1?s.queryResultsArr.push(u):s.queryResultsArr[n]=u,e.go("listqueries.run-query")}).catch(function(r,t,a,u){s.errorMessage="listqueries.failed",e.go("listqueries.failed")})},s.goToBuilder=function(r){e.go("querybuilder",{queryId:r.queryId})},s.deleteQuery=function(e){n.deleteDoc("openrecipes","query",e._id).then(function(t){r.vmShared.resultQueries.splice(r.vmShared.resultQueries.indexOf(e),1),console.log("Query deleted succcessfully !")}).catch(function(e){console.log("Failed to delete query !"),s.errorMessage=e.message,console.trace(e.message)})}}angular.module("app").controller("listQueriesCtrl",["$state","$scope","$http","$window","esSearchSvc","esModifySvc","listQueries",e])}(),function(){"use strict";function e(e,r,t,a,u,n){}angular.module("app").controller("showQueryCtrl",["$state","$scope","$window","esSearchSvc","esModifySvc","listQueries",e])}();
